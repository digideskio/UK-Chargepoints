<!doctype html>
<html>

<head>

  <title>UK Charge Points</title>

  <meta name="viewport"
  content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

  <script src="/bower_components/platform/platform.js"></script>

  <link rel="import"
    href="/bower_components/font-roboto/roboto.html">

  <link rel="import"
    href="/bower_components/core-header-panel/core-header-panel.html">
  <link rel="import"
    href="/bower_components/core-drawer-panel/core-drawer-panel.html">
  <link rel="import"
    href="/bower_components/core-toolbar/core-toolbar.html">
  <link rel="import"
    href="/bower_components/core-list/core-list.html">
  <link rel="import"
    href="/bower_components/core-icon-button/core-icon-button.html">
  <link rel="import"
    href="/bower_components/paper-item/paper-item.html">
  <link rel="import"
    href="/bower_components/core-icons/maps-icons.html">
  <link rel="import"
    href="/bower_components/google-map/google-map.html">
  <link rel="import"
    href="/bower_components/core-ajax/core-ajax.html">

  <style>
  html,body {
    height: 100%;
    margin: 0;
    background-color: #E5E5E5;
    font-family: 'RobotoDraft', sans-serif;
  }
  .container {
    width: 80%;
    margin: 50px auto;
  }
  @media (min-width: 481px) {
    #tabs {
      width: 200px;
    }
    .container {
      width: 400px;
    }
  }

  core-header-panel {
    height: 100%;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }
  core-toolbar {
    background: orange;
    color: white;
  }
  core-icon-button {
      color:white;
  }
  core-drawer-panel {
    background: white;
  }
  google-map {
    display: block;
    height: 600px;
  }
  </style>

</head>

<body unresolved>
  <core-header-panel>

  <core-toolbar>
    <div flex>UK Charge Points</div>
    <core-icon-button icon="maps:my-location" id="locate"></core-icon-button>
    <core-icon-button icon="refresh" id="refresh"></core-icon-button>
    <core-icon-button icon="list" id="drawer-toggle"></core-icon-button>
  </core-toolbar>

  <core-drawer-panel rightDrawer>
    <core-header-panel drawer id="drawer">
      <core-list>
        <template>
          <div class="{{ {selected: selected} | tokenList }}">
            <paper-item label="{{model.value.ChargeDeviceName}}" id="item-{{model.value.ChargeDeviceId}}"></paper-item>
          </div>
        </template>
      </core-list>
    </core-header-panel>
    <div main>
      <google-map></google-map>
    </div>
  </core-drawer-panel>


  </core-header-panel>
  <core-ajax
    url="/api/ChargePoints"
    handleAs="json">
  </core-ajax>
  <script>
    var tabs = document.querySelector('paper-tabs');

    var chargePointsApi = document.querySelector('core-ajax');

    var map = document.querySelector('google-map');
    map.latitude = 51.48;
    map.longitude = 0;

    var drawer = document.querySelector('#drawer');
    var list = document.querySelector('core-list');

    map.addEventListener('google-map-ready', function(e) {
      google.maps.event.addListener(map.map, 'idle', function() {
        loadChargePoints(map);
      });
    });

    list.addEventListener('core-activate', function(e) {
      var deviceId = e.detail.data.value.ChargeDeviceId;
      console.log(document.querySelector("#marker-" + deviceId).__proto__);
    });

    chargePointsApi.addEventListener('core-response', function(e) {
      clear();

      list.data = chargePointsApi.response.results;
      for (i in chargePointsApi.response.results) {
        var result = chargePointsApi.response.results[i].value;

        if (result.ChargeDeviceLocation.Latitude == null || result.ChargeDeviceLocation.Longitude == null) continue;

        var marker = document.createElement('google-map-marker');
        marker.latitude = result.ChargeDeviceLocation.Latitude;
        marker.longitude = result.ChargeDeviceLocation.Longitude;
        marker.id = "marker-"+result.ChargeDeviceId;
        marker.innerHTML = result.ChargeDeviceName;

        map.appendChild(marker);
      }
      map.fitToMarkers = true;
      map.fitToMarkers = false;
    });

    var boundingBoxUK =  {
      north: 60.854691,
      east: 1.768960,
      south: 49.162090,
      west: -13.413930
    };

    function clear() {
      map.clear();
      list.data = [];
    }

    function intersectsUK(bounds) {
      var ne = new google.maps.LatLng(boundingBoxUK.north, boundingBoxUK.east);
      var sw = new google.maps.LatLng(boundingBoxUK.south, boundingBoxUK.west);
      var ukBounds = new google.maps.LatLngBounds(sw, ne);

      return ukBounds.intersects(bounds);
    }

    function inUK(coords) {
      var ne = new google.maps.LatLng(boundingBoxUK.north, boundingBoxUK.east);
      var sw = new google.maps.LatLng(boundingBoxUK.south, boundingBoxUK.west);
      var ukBounds = new google.maps.LatLngBounds(sw, ne);

      var latlng = new google.maps.LatLng(coords.latitude, coords.longitude);
      return ukBounds.contains(latlng);
    }

    function loadChargePoints(map) {
      var bounds = map.map.getBounds();

      if (!intersectsUK(bounds)) {
        alert("You cannot search outside the UK.");
        return;
      }

      var ne = bounds.getNorthEast()
      var sw = bounds.getSouthWest()

      chargePointsApi.params =  '{' +
                                  '"sort":"value.ChargeDeviceLocation:distance:asc",' +
                                  '"limit":"100",' +
                                  '"query":"value.ChargeDeviceLocation:IN:{north:'+ne.lat()+' east:'+ne.lng()+' south:'+sw.lat()+' west:'+sw.lng()+'}"' +
                                '}';
      chargePointsApi.go();
    }

    document.querySelector('#refresh').addEventListener('click', function () {
      clear();
      loadChargePoints(map);
    });

    document.querySelector('#locate').addEventListener('click', function () {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(geo) {
          if (inUK(geo.coords)) {
            clear();
            map.latitude = geo.coords.latitude;
            map.longitude = geo.coords.longitude;
            map.zoom = 15;
          } else {
            alert("You cannot search outside the UK.");
          }
        });
      }
    });

    document.querySelector('#drawer-toggle').addEventListener('click', function(e) {
      document.querySelector('core-drawer-panel').togglePanel();
    });
  </script>
</body>

</html>
